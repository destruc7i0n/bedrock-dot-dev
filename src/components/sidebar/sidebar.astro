---
import Selectors from "./sidebar-selectors";
import SidebarFilter from "./sidebar-filter.astro";
import SidebarContent from "./sidebar-content";
import ModeSelect from "@components/theme/mode-select.astro";
import type { SidebarStructure } from "./index";
import type { BedrockVersions } from "../../lib/versions";
import type { TagsResponse } from "../../lib/tags";
import { MOBILE_BREAKPOINT } from "@lib/breakpoints";

import "../../styles/sidebar.scss";

interface Props {
  sidebar: SidebarStructure;
  file: string;
  major: string;
  minor: string;
  versions: BedrockVersions;
  tags: TagsResponse;
}

const { sidebar, file, major, minor, versions, tags } = Astro.props;

const sidebarScript = `try {
  const isMobile = window.matchMedia("(max-width: ${MOBILE_BREAKPOINT}px)");
  const stored = localStorage.getItem("sidebar");
  const sidebarState = stored === null ? true : stored === "true";
  const open = isMobile.matches ? false : sidebarState;
  if (open) document.querySelector(".sidebar")?.classList.add("open");
} catch {}`;
---

<div>
  <aside class="sidebar">
    <div class="w-full border-b border-gray-200 p-4 dark:border-dark-gray-800">
      <Selectors
        transition:persist="sidebar-selectors"
        client:load
        major={major}
        minor={minor}
        file={file}
        versions={versions}
        tags={tags}
      />
      <SidebarFilter />
    </div>
    <SidebarContent client:load sidebar={sidebar} file={file} />
    <div
      class="bottom-safe-area-inset inset-2 flex w-full flex-row items-center justify-end border-t border-gray-200 bg-white px-4 py-2 dark:border-dark-gray-800 dark:bg-dark-gray-950"
    >
      <ModeSelect transition:persist="sidebar-mode-select" />
    </div>
  </aside>
  <div class="sidebar-mask" transition:persist="sidebar-mask"></div>
</div>

<script is:inline set:html={sidebarScript} />

<script>
  import { sidebarOpen } from "@stores/sidebar-open";
  import { MOBILE_BREAKPOINT } from "@lib/breakpoints";

  document.addEventListener("astro:page-load", () => {
    const sidebar = document.querySelector(".sidebar");
    const mask = document.querySelector(".sidebar-mask");
    const mobile = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT}px)`);

    const updateBodyScroll = () => {
      document.body.style.overflow =
        mobile.matches && sidebarOpen.get() ? "hidden" : "";
    };

    const unsub = sidebarOpen.subscribe((open) => {
      sidebar?.classList.toggle("open", open);
      updateBodyScroll();
    });

    const handleMaskClick = () => sidebarOpen.set(false);
    mask?.addEventListener("click", handleMaskClick);
    mobile.addEventListener("change", updateBodyScroll);
    requestAnimationFrame(() => sidebar?.classList.add("mounted"));

    document.addEventListener(
      "astro:before-preparation",
      () => {
        unsub();
        mask?.removeEventListener("click", handleMaskClick);
        mobile.removeEventListener("change", updateBodyScroll);
        document.body.style.overflow = "";
      },
      { once: true },
    );
  });
</script>
